#!/usr/bin/env bash
#
# run_matlab <command>
set -e

locate_matlab () {
  if which matlab &>/dev/null; then
    matlab=matlab
  else
    os=$(uname)
    if [[ $os -eq "Darwin" ]]; then
        search_order="${PREFERRED_MATLAB_VERSIONS:-R2024b R2024a R2023b R2023a R2022b R2022a R2021b R2021a R2020b R2020a R2019b R2019a R2018b R2018a}"
        for rel in $search_order; do
          app_path="/Applications/MATLAB_${rel}.app"
          # echo Checking for $rel at $app_path
          if [[ -e "$app_path" ]]; then
            # echo Found $rel at $app_path
            matlab="$app_path/bin/matlab"
            break
          fi
        done
    else
      echo >&2 "Error: No matlab on path, and I don't know how to detect it on Linux."
      echo >&2 "Error: Please ensure Matlab is installed, and get it on your \$PATH."
      exit 1
    fi
  fi

  if [[ -z "$matlab" ]]; then
    echo >&2 "Error: matlab is not on the path and it could not be detected."
    exit 1
  fi
}

locate_matlab

bin_dir=$(dirname $0)
reporoot=$(dirname "$bin_dir")
devkit_dir="$reporoot/dev-kit"
matlab -batch "addpath '$reporoot/Mcode'; addpath '${devkit_dir}'; $1"
